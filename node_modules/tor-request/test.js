var iconv = require( 'iconv-lite' )

var fs = require( 'fs' )
var tr = require('./index.js');
var r = require( 'request' )

var stream = require( 'stream' )
var ws = stream.Writable()
ws._write = function ( chunk, enc, next ) {
  console.log( chunk.toString() )
  next()
}


tr.request(
  {
    url: 'https://www.worldcat.org/title/science/oclc/52065228?client=worldcat.org-detailed_record&page=endnote'
  }
)
.pipe( iconv.decodeStream( 'ISO-8859-1' ) )
.pipe( ws )

/*
tr.request(
  {
    url: 'https://www.worldcat.org/title/science/oclc/52065228?client=worldcat.org-detailed_record&page=endnote'
  }
)
.pipe( iconv.decodeStream( 'ISO-8859-1' ) )
.pipe( process.stdout )
*/

/*
tr.request(
  {
    url: 'https://www.worldcat.org/title/science/oclc/52065228?client=worldcat.org-detailed_record&page=endnote'
  }
)
.on( 'response', function ( res ) {
  console.log( res.headers[ 'content-type' ] ) // 'application/x-research-info-systems;charset=ISO-8859-1'

  var chunks = []
  res.on( 'data', function ( chunk ) {
    chunks.push( chunk )
  } )

  res.on( 'end', function () {
    console.log( chunks )
    const str = iconv.decode( Buffer.concat( chunks ), 'ISO-8859-1' )
    console.log( str )
    // fs.writeFileSync( 'ris', str, { encoding: 'utf8' } )
  } )
} )
*/

/*
r(
  {
    url: 'https://www.worldcat.org/title/science/oclc/52065228?client=worldcat.org-detailed_record&page=endnote',
    headers: { 'accept-encoding': 'utf8' }
  }
)
.on( 'response', function ( res ) {
  console.log( res.headers[ 'content-type' ] ) // 'application/x-research-info-systems;charset=ISO-8859-1'

  var chunks = []
  res.on( 'data', function ( chunk ) {
    chunks.push( chunk )
  } )

  res.on( 'end', function () {
    console.log( chunks )
    const str = iconv.decode( Buffer.concat( chunks ), 'ISO-8859-1' )

    console.log( str )
    fs.writeFileSync( 'ris', str, { encoding: 'utf8' } )
  } )
} )
*/

// r(
//   {
//     url: 'https://www.worldcat.org/title/science/oclc/52065228?client=worldcat.org-detailed_record&page=endnote'
//   }
// )
// .pipe( fs.createWriteStream( 'ris', { encoding: 'utf8' } ) )
